Bootstrap: docker
From: nvidia/cuda:12.4.0-base-ubuntu22.04


%post
    export DEBIAN_FRONTEND=noninteractive

    apt-get update && apt-get upgrade -y
    apt-get install -y software-properties-common curl git pciutils wget

    add-apt-repository ppa:deadsnakes/ppa -y
    apt-get update

    # Install Python 3.12 (recommended for Open WebUI v0.6.36)
    apt-get install -y python3.12 python3.12-venv python3.12-dev

    curl -sS https://bootstrap.pypa.io/get-pip.py | python3.12

    # Install Node.js 20.x LTS (required for Open WebUI v0.6.36)
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    apt-get install -y nodejs

    # Install Ollama v0.12.10
    curl -fsSL https://ollama.com/install.sh | sh

    # Create and activate a virtual environment for Open WebUI using Python 3.12
    python3.12 -m venv /opt/open-webui-venv
    . /opt/open-webui-venv/bin/activate

    # Install Open WebUI v0.6.36
    pip install open-webui==0.6.36

    # Deactivate virtual environment
    deactivate


%environment
    export PATH=/opt/open-webui-venv/bin:$PATH


%startscript
    # Start the Ollama service
    /usr/local/bin/ollama serve &

    # Activate the virtual environment and start Open WebUI
    . /opt/open-webui-venv/bin/activate
    open-webui serve --host 0.0.0.0 --port 8080
    deactivate


%labels
    Author: Gabriel Freytag
    Version: 1.0.0
    Description: Singularity container for DeepSeek with Open WebUI v0.6.36 and Ollama v0.12.10
